var configClass=function(){function a(){this.mapId="map",this.gpxFile="data/track.gpx",this.boundOptions={paddingBottomRight:L.point(200,10),paddingTopLeft:L.point(10,10)},this.labelOptions={className:"trackTooltip",direction:"auto"},this.subTrackOptions={color:"red",opacity:1}}return a}(),helperClass=function(){function a(){}return a.prototype.getDistance=function(a,b,c,d){var e=6371,f=this.deg2rad(c-a),g=this.deg2rad(d-b),h=Math.sin(f/2)*Math.sin(f/2)+Math.cos(this.deg2rad(a))*Math.cos(this.deg2rad(c))*Math.sin(g/2)*Math.sin(g/2),i=2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)),j=e*i;return j},a.prototype.deg2rad=function(a){return a*(Math.PI/180)},a}(),trackvizClass=function(){function a(a,b){this.isMoving=!1;var c=this;c.map=a,c.gpxTrack=new L.GPX(b,{async:!0}),c.gpxTrack.on("loaded",function(b){c.trackPoints=c.gpxTrack.get_trackpoints(),c.currentMarker=L.marker(c.trackPoints[0],{icon:L.divIcon({className:"leaflet-div-icon showpoint",html:"x"})}).addTo(a),$.grep(c.gpxTrack.getLayers().shift().getLayers(),function(a){return"function"==typeof a.getLatLngs}),c.gpxTrack.on("mousemove",c.updateTooltip),c.gpxTrack.on("click",c.moveToMousePosition),c.map.fitBounds(c.gpxTrack.getBounds(),conf.boundOptions)}).addTo(c.map)}return a.prototype.moveTo=function(a){var b=this;if(!b.isMoving){b.isMoving=!0;var c=b.getTrackPointByLatlng(b.currentMarker.getLatLng()),d=b.trackPoints.indexOf(c),e=c.meta.time>a.meta.time?!0:!1;!function f(e){var g=e?-1:1;d+=g,c=b.trackPoints[d],!e&&c.meta.time<=a.meta.time||e&&c.meta.time>=a.meta.time?(b.currentMarker.setLatLng(L.latLng(c.lat,c.lng)).update(),b.movingTimer=setTimeout(function(){f(e)},1)):b.isMoving=!1}(e)}},a.prototype.stopMoving=function(){var a=this;clearTimeout(a.movingTimer),a.isMoving=!1},a.prototype.highlightSubTrack=function(a,b){var c=this,d=c.trackPoints.indexOf(a),e=c.trackPoints.indexOf(b),f=c.trackPoints.slice(d,e+1);c.subTrack&&c.map.removeLayer(c.subTrack),c.subTrack=new L.FeatureGroup([new L.Polyline(f,conf.subTrackOptions)]).bindLabel("",conf.labelOptions).addTo(c.map)},a.prototype.getTrackPointByLatlng=function(a){var b=this;return $.grep(b.trackPoints,function(b){return b.lat==a.lat&&b.lng==a.lng}).shift()},a.prototype.findNearestTrackPoint=function(a,b){var c,d=this,e=9999;return d.trackPoints.forEach(function(d){var f=helper.getDistance(a,b,d.lat,d.lng);e>f&&(e=f,c=d)}),c},a.prototype.moveToMousePosition=function(a){var b=this;b.moveTo(b.findNearestTrackPoint(a.latlng.lat,a.latlng.lng))},a.prototype.updateTooltip=function(a){var b=this,c=b.findNearestTrackPoint(a.latlng.lat,a.latlng.lng),d=c.meta.time,e=d.getMonth()+1;$(".trackTooltip").html("<p>Time: "+d.getDate()+"."+e+"."+d.getFullYear()+" "+d.getHours()+":"+d.getMinutes()+"</p><p>Height: "+c.meta.ele+"</p>")},a}(),foo="bar",conf=new configClass,helper=new helperClass,map=L.map(conf.mapId);L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",{maxZoom:16}).addTo(map);var trackviz=new trackvizClass(map,conf.gpxFile);$("#run").click(function(){trackviz.moveTo(trackviz.trackPoints[trackviz.trackPoints.length-1])}),$("#pause").click(trackviz.stopMoving);